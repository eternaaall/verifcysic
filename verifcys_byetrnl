#!/bin/bash

clear
echo
echo "╔══════════════════════════════════════╗"
echo "║     🚀 Cysic Simple Verifier         ║"
echo "║     created by eternaaall           ║"
echo "╚══════════════════════════════════════╝"
echo

WALLET_FILE="$HOME/.cysic_wallet"
if [[ -f "$WALLET_FILE" ]]; then
    WALLET=$(cat "$WALLET_FILE")
    echo "🔑 Using saved wallet address: $WALLET"
else
    while true; do
        read -p "Enter your EVM wallet address: " WALLET
        if [[ "$WALLET" =~ ^0x[a-fA-F0-9]{40}$ ]]; then
            echo "$WALLET" > "$WALLET_FILE"
            break
        else
            echo "❌ Invalid ETH address format. Try again."
        fi
    done
fi

if [[ ! -f "$HOME/.cysic_apt_installed" ]]; then
    echo "📦 Installing dependencies..."
    sudo apt update
    sudo apt install -y screen curl
    touch "$HOME/.cysic_apt_installed"
else
    echo "📦 Dependencies already installed."
fi

if [[ ! -f /etc/systemd/system/cysic.service ]]; then
    echo "⚙️ Creating systemd service file..."
    sudo bash -c 'cat > /etc/systemd/system/cysic.service <<EOF
[Unit]
Description=Cysic Verifier Node
After=network.target

[Service]
User=root
Group=root
WorkingDirectory=/root/cysic-verifier
Environment="LD_LIBRARY_PATH=/root/cysic-verifier"
Environment="CHAIN_ID=534352"
ExecStart=/root/cysic-verifier/verifier
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF'
fi

if [[ ! -f /root/cysic-verifier/verifier ]]; then
    echo "📅 Installing verifier..."
    curl -L https://github.com/cysic-labs/cysic-phase3/releases/download/v1.0.0/setup_linux.sh -o ~/setup_linux.sh
    if [[ -f ~/setup_linux.sh ]]; then
        bash ~/setup_linux.sh "$WALLET"
        echo "✅ Verifier installed."
    else
        echo "❌ Failed to download setup script."
        exit 1
    fi
fi

# Create counter file for session numbering
COUNTER_FILE="$HOME/.cysic_session_counter"
[[ ! -f "$COUNTER_FILE" ]] && echo 0 > "$COUNTER_FILE"

while true; do
    echo
    echo "=========== Cysic Verifier Menu ==========="
    echo "1) View status and logs"
    echo "2) Launch a new Verifier"
    echo "3) Update Verifier"
    echo "4) Stop all sessions"
    echo "5) Full Reset + key"
    echo "6) Exit"
    echo "==========================================="
    read -p "Choose option: " OPTION
    echo

    case $OPTION in
        1)
            echo "Available sessions:"
            for s in $(screen -ls | grep cysic | awk '{print $1}'); do
                NAME=$(echo "$s" | cut -d. -f2)
                LOG_FILE="/var/log/${NAME}.log"
                WORKER=$(grep -a "your current worker address is:" "$LOG_FILE" 2>/dev/null | tail -1 | grep -oE '0x[a-fA-F0-9]{40}')
                RESTARTS=$(grep -c "verifier exited" "$LOG_FILE" 2>/dev/null)
                echo "[${NAME}] ${WORKER:-no worker yet} | Restarts: ${RESTARTS}"
            done
            read -p "Enter session number to attach (e.g. 1 for 1cysic): " ID
            screen -r "${ID}cysic"
            ;;

        2)
            read -p "Are you sure you want to launch a new session? (y/n): " CONFIRM
            [[ "$CONFIRM" != "y" ]] && echo "Cancelled." && continue
            INDEX=$(cat "$COUNTER_FILE")
            NAME="${INDEX}cysic"
            echo $((INDEX + 1)) > "$COUNTER_FILE"
            LOG="/var/log/${NAME}.log"
            read -p "Do you want to delete the current key before launch? (y/n): " DELKEY
            [[ "$DELKEY" == "y" ]] && echo "🗝 Deleting /root/.cysic/keys/..." && rm -rf /root/.cysic/keys/
            echo "🚀 Starting session: $NAME"
            screen -dmS "$NAME" bash -c "cd /root/cysic-verifier && while true; do LD_LIBRARY_PATH=/root/cysic-verifier CHAIN_ID=534352 ./verifier 2>&1 | tee -a '$LOG'; echo '[!] verifier exited, restarting in 5s...'; sleep 5; done"
            ;;

        3)
            read -p "Are you sure you want to update the verifier? This will delete all sessions and keys. (y/n): " CONFIRM
            [[ "$CONFIRM" != "y" ]] && echo "Cancelled." && continue
            echo "🔚 Stopping all sessions..."
            screen -ls | grep cysic | cut -d. -f1 | awk '{print $1}' | xargs -r kill
            echo "🛃 Removing logs..."
            rm -f /var/log/cysic*.log
            echo "🗝 Deleting keys..."
            rm -rf /root/.cysic/keys/
            echo "🔄 Updating verifier..."
            rm -rf /root/cysic-verifier/
            curl -L https://github.com/cysic-labs/cysic-phase3/releases/download/v1.0.0/setup_linux.sh -o ~/setup_linux.sh
            bash ~/setup_linux.sh "$WALLET"
            ;;

        4)
            read -p "Are you sure you want to stop all sessions? (y/n): " CONFIRM
            [[ "$CONFIRM" != "y" ]] && echo "Cancelled." && continue
            echo "🔚 Stopping all sessions..."
            screen -ls | grep cysic | cut -d. -f1 | awk '{print $1}' | xargs -r kill
            echo "🛃 Removing logs..."
            rm -f /var/log/cysic*.log
            ;;

        5)
            read -p "Are you sure you want to perform FULL reset (sessions, logs, keys)? (y/n): " CONFIRM
            [[ "$CONFIRM" != "y" ]] && echo "Cancelled." && continue
            echo "🔚 Stopping all sessions..."
            screen -ls | grep cysic | cut -d. -f1 | awk '{print $1}' | xargs -r kill
            echo "🛃 Removing logs..."
            rm -f /var/log/cysic*.log
            echo "🗝 Deleting keys from /root/.cysic/keys/..."
            rm -rf /root/.cysic/keys/
            echo "🧼 Full reset complete."
            ;;

        6)
            echo "👋 Bye!"
            exit 0
            ;;

        *)
            echo "❌ Invalid option."
            ;;
    esac
done
